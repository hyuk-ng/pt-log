<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="ì²´ë ¥ì¸¡ì •">
<title>Body Spectrum Pro | ì²´ë ¥ì¸¡ì •í‰ê°€</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans KR',sans-serif;background:#f0f2f5;padding:10px 10px 90px;-webkit-user-select:none;user-select:none;}
.container{max-width:800px;margin:0 auto;}

/* Header */
.app-header{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);border-radius:20px;padding:22px 24px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}
.app-header h1{color:white;font-size:20px;font-weight:900;}
.app-header h1 span{color:#00d4aa;}
.logo-sm{color:#64748b;font-size:11px;font-weight:700;letter-spacing:1px;}

/* Tabs */
.tabs{display:flex;gap:3px;margin-bottom:12px;background:#e2e8f0;border-radius:14px;padding:4px;}
.tab{flex:1;padding:11px 6px;border:none;border-radius:11px;background:transparent;font-size:12px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;color:#94a3b8;transition:all 0.2s;text-align:center;}
.tab.active{background:white;color:#0f172a;box-shadow:0 2px 8px rgba(0,0,0,0.08);}

/* Cards */
.card{background:white;border-radius:16px;padding:18px;margin-bottom:10px;box-shadow:0 2px 12px rgba(0,0,0,0.05);}
.card-title{font-size:14px;font-weight:800;color:#0f172a;margin-bottom:12px;display:flex;align-items:center;gap:6px;}

/* Score display */
.score-hero{text-align:center;padding:20px 0;}
.level-badge{display:inline-block;padding:6px 20px;border-radius:50px;color:white;font-weight:900;font-size:13px;letter-spacing:1px;}
.score-big{font-size:72px;font-weight:900;line-height:1;margin:8px 0;}
.score-big .sub{font-size:24px;color:#94a3b8;}
.level-msg{font-size:16px;font-weight:800;margin-top:4px;}

/* Radar */
.radar-wrap{height:280px;margin:10px auto;max-width:400px;}

/* Grade table */
.grade-table{width:100%;border-collapse:collapse;font-size:12px;margin-top:10px;}
.grade-table th{background:#f8fafc;padding:8px;font-weight:700;color:#64748b;border-bottom:2px solid #e2e8f0;}
.grade-table td{padding:8px;text-align:center;border-bottom:1px solid #f1f5f9;}
.grade-pill{display:inline-block;padding:2px 10px;border-radius:20px;font-weight:700;font-size:11px;color:white;}

/* Forms */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.form-group{display:flex;flex-direction:column;gap:3px;}
.form-group label{font-size:10px;font-weight:700;color:#94a3b8;letter-spacing:0.5px;}
.fi{padding:10px 12px;border:2px solid #e8e8e8;border-radius:10px;font-size:14px;font-weight:600;font-family:'Noto Sans KR',sans-serif;outline:none;color:#333;width:100%;transition:border 0.2s;}
.fi:focus{border-color:#00d4aa;}
select.fi{cursor:pointer;}

/* Section labels */
.sec-label{font-size:11px;font-weight:800;color:white;background:#0f172a;display:inline-block;padding:3px 10px;border-radius:5px;margin:8px 0 6px;letter-spacing:1px;}

/* Measure grid */
.mg{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px;}
.mi{background:#f8fafc;border-radius:10px;padding:8px;text-align:center;}
.mi label{font-size:9px;font-weight:700;color:#94a3b8;display:block;margin-bottom:3px;}
.mi input{width:100%;text-align:center;padding:6px;border:2px solid #e8e8e8;border-radius:8px;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;outline:none;color:#333;}
.mi input:focus{border-color:#00d4aa;}
.mi .unit{font-size:9px;color:#bbb;margin-top:2px;}

/* ACSM */
.acsm-ck{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;margin-bottom:6px;background:#f8fafc;cursor:pointer;}
.acsm-ck input{width:18px;height:18px;accent-color:#00d4aa;}
.acsm-ck span{font-size:12px;font-weight:600;color:#444;}
.acsm-result{padding:12px;border-radius:10px;font-size:13px;font-weight:700;line-height:1.5;margin-top:8px;}
.acsm-result.safe{background:#e8f5e9;color:#2e7d32;border:2px solid #a5d6a7;}
.acsm-result.warn{background:#fff3e0;color:#e65100;border:2px solid #ffcc80;}
.acsm-result.danger{background:#ffebee;color:#c62828;border:2px solid #ef9a9a;}

/* Analysis text */
.analysis-box{background:#f8fafc;border-radius:12px;padding:14px;margin-top:10px;font-size:13px;line-height:1.7;color:#475569;}
.analysis-box strong{color:#0f172a;}

/* Buttons */
.btn{padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;width:100%;transition:all 0.2s;}
.btn-primary{background:#0f172a;color:white;}
.btn-primary:hover{background:#1e293b;}
.btn-save{background:#10b981;color:white;margin-top:6px;}
.btn-cap{background:#3b82f6;color:white;margin-top:6px;}
.btn-row{display:flex;gap:6px;margin-top:8px;}
.btn-row .btn{flex:1;}

/* Member search */
.ms-wrap{position:relative;}
.ms-input{width:100%;padding:10px 12px;border:2px solid #e8e8e8;border-radius:10px;font-size:14px;font-weight:600;font-family:'Noto Sans KR',sans-serif;outline:none;color:#333;}
.ms-input:focus{border-color:#00d4aa;}
.ms-dd{position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #e8e8e8;border-top:none;border-radius:0 0 10px 10px;max-height:160px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.ms-dd.show{display:block;}
.ms-item{padding:10px 12px;font-size:13px;font-weight:600;cursor:pointer;color:#555;}
.ms-item:hover{background:#00d4aa;color:white;}

/* Chart */
.chart-wrap{position:relative;height:260px;margin:10px 0;}
.chip-row{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;}
.chip{padding:5px 10px;border-radius:20px;border:2px solid #e0e0e0;background:white;font-size:10px;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;color:#888;}
.chip.on{color:white;}

/* History */
.hist-card{background:#f8fafc;border-radius:12px;padding:12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all 0.15s;}
.hist-card:hover{background:#e8f5e9;}
.hist-card.active{background:#00d4aa20;border:2px solid #00d4aa;}
.hist-info{flex:1;}
.hist-date{font-size:13px;font-weight:700;color:#333;}
.hist-sub{font-size:11px;color:#94a3b8;margin-top:2px;}
.hist-score{font-size:20px;font-weight:900;margin-right:10px;}
.hist-del{width:24px;height:24px;border:none;border-radius:50%;background:transparent;color:#ccc;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.hist-del:hover{background:#e53935;color:white;}

/* Toast / Modal */
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:white;padding:16px 28px;border-radius:14px;font-size:15px;font-weight:600;z-index:9999;display:none;text-align:center;}
.toast.show{display:block;animation:fadeIO 2.5s ease;}
@keyframes fadeIO{0%{opacity:0;transform:translate(-50%,-50%) scale(0.9);}15%{opacity:1;transform:translate(-50%,-50%) scale(1);}75%{opacity:1;}100%{opacity:0;}}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:8000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.show{display:flex;}
.modal-box{background:white;border-radius:16px;padding:24px;width:320px;}
.modal-title{font-size:16px;font-weight:800;margin-bottom:12px;}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:14px;}
.modal-btn{padding:10px 20px;border-radius:10px;border:none;font-size:13px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;}
.modal-btn.cancel{background:#f0f0f0;color:#666;}
.modal-btn.ok{background:#00d4aa;color:#111;}

.page{display:none;}.page.active{display:block;}
.empty-msg{text-align:center;padding:30px;color:#bbb;font-size:13px;font-weight:600;}
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="addModal">
  <div class="modal-box">
    <div class="modal-title">ìƒˆ íšŒì› ë“±ë¡</div>
    <input class="fi" id="newName" placeholder="íšŒì› ì´ë¦„" autocomplete="off" onkeydown="if(event.key==='Enter')addMemberOk()" style="margin-bottom:10px;"/>
    <div class="modal-btns"><button class="modal-btn cancel" onclick="document.getElementById('addModal').classList.remove('show')">ì·¨ì†Œ</button><button class="modal-btn ok" onclick="addMemberOk()">ë“±ë¡</button></div>
  </div>
</div>
<!-- Detail Modal -->
<div class="modal-overlay" id="detailModal">
  <div class="modal-box" style="width:360px;max-height:80vh;overflow-y:auto;">
    <div class="modal-title" id="detailTitle"></div>
    <div id="detailContent" style="font-size:13px;line-height:1.8;color:#475569;"></div>
    <div class="modal-btns"><button class="modal-btn ok" onclick="document.getElementById('detailModal').classList.remove('show')">ë‹«ê¸°</button></div>
  </div>
</div>

<div class="container">
  <div class="app-header">
    <h1>ğŸ‹ï¸ Body Spectrum <span>Pro</span></h1>
    <div class="logo-sm">BODY SPECTRUM</div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab(0)">ğŸ“‹ ì¸¡ì •</button>
    <button class="tab" onclick="switchTab(1)">ğŸ† ë¦¬í¬íŠ¸</button>
    <button class="tab" onclick="switchTab(2)">ğŸ“Š ê·¸ë˜í”„</button>
    <button class="tab" onclick="switchTab(3)">ğŸ“ ê¸°ë¡</button>
  </div>

  <!-- TAB 0: ì¸¡ì • -->
  <div class="page active" id="page0">
    <div class="card">
      <div class="card-title">ğŸ‘¤ íšŒì› ì„ íƒ</div>
      <div class="ms-wrap">
        <input class="ms-input" id="ms0" placeholder="íšŒì› ê²€ìƒ‰..." oninput="filterMS(0)" onfocus="filterMS(0)" autocomplete="off"/>
        <div class="ms-dd" id="mdd0"></div>
      </div>
      <input type="hidden" id="selMember"/>
      <div class="btn-row">
        <button class="btn btn-primary" style="padding:8px;" onclick="showAddModal()">ï¼‹ ìƒˆ íšŒì›</button>
        <button class="btn" style="padding:8px;background:#f0f0f0;color:#555;" onclick="refreshAll()">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ©º ACSM ì‚¬ì „ ìŠ¤í¬ë¦¬ë‹</div>
      <label class="acsm-ck"><input type="checkbox" id="ckA"><span>ìµœê·¼ 3ê°œì›”ê°„ ê·œì¹™ì ìœ¼ë¡œ ìš´ë™? (ì£¼3íšŒ, 30ë¶„+)</span></label>
      <label class="acsm-ck"><input type="checkbox" id="ckD"><span>ì‹¬ì¥/ëŒ€ì‚¬/ì‹ ì¥ ì§ˆí™˜ ì§„ë‹¨ì„ ë°›ìŒ?</span></label>
      <label class="acsm-ck"><input type="checkbox" id="ckS"><span>ìš´ë™ ì¤‘ ê°€ìŠ´í†µì¦/í˜„ê¸°ì¦/ìˆ¨ê°€ì¨ ì¦ìƒ?</span></label>
      <div id="acsmR"></div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“ ê¸°ë³¸ ì •ë³´ & ì²´ì„±ë¶„</div>
      <div class="form-row">
        <div class="form-group"><label>ë‚˜ì´</label><input class="fi" id="mAge" type="number" placeholder="30"></div>
        <div class="form-group"><label>ì„±ë³„</label><select class="fi" id="mGender"><option value="ë‚¨">ë‚¨</option><option value="ì—¬">ì—¬</option></select></div>
      </div>
      <div class="mg">
        <div class="mi"><label>ì‹ ì¥</label><input id="mH" type="number" step="0.1" placeholder="175"><div class="unit">cm</div></div>
        <div class="mi"><label>ì²´ì¤‘</label><input id="mW" type="number" step="0.1" placeholder="70"><div class="unit">kg</div></div>
        <div class="mi"><label>ì²´ì§€ë°©ë¥ </label><input id="mBF" type="number" step="0.1" placeholder="18"><div class="unit">%</div></div>
        <div class="mi"><label>ê³¨ê²©ê·¼ëŸ‰</label><input id="mSMM" type="number" step="0.1" placeholder="32"><div class="unit">kg</div></div>
        <div class="mi"><label>BMI</label><input id="mBMI" readonly style="background:#f0f0f0;color:#00d4aa;"><div class="unit">ìë™</div></div>
        <div class="mi"><label>í—ˆë¦¬ë‘˜ë ˆ</label><input id="mWaist" type="number" step="0.1" placeholder="80"><div class="unit">cm</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ’ª ê·¼ë ¥ & í¼í¬ë¨¼ìŠ¤</div>
      <div class="sec-label">ê°„ì ‘ 1RM ì¸¡ì • (Brzycki ê³µì‹)</div>
      <div style="background:#f0fdf4;border-radius:10px;padding:10px;margin-bottom:10px;">
        <div style="font-size:11px;color:#64748b;margin-bottom:8px;">ğŸ’¡ ìˆ˜í–‰í•œ ë¬´ê²Œì™€ íšŸìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ <b>ì¶”ì • 1RM</b>ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</div>
        <div style="display:grid;grid-template-columns:1fr;gap:10px;">
          <!-- Power Leg Press -->
          <div style="background:white;border-radius:10px;padding:12px;border:2px solid #e8e8e8;">
            <div style="font-size:12px;font-weight:800;color:#0f172a;margin-bottom:6px;">ğŸ¦µ íŒŒì›Œ ë ˆê·¸í”„ë ˆìŠ¤</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;">
              <div class="mi"><label>ë¬´ê²Œ</label><input id="mLPw" type="number" placeholder="180" oninput="calc1RM('LP')"><div class="unit">kg</div></div>
              <div class="mi"><label>íšŸìˆ˜</label><input id="mLPr" type="number" placeholder="8" oninput="calc1RM('LP')"><div class="unit">íšŒ</div></div>
              <div class="mi"><label>ë¨¸ì‹  ê°ë„</label><select id="mLPa" class="fi" style="padding:6px;font-size:12px;" onchange="calc1RM('LP')"><option value="45">45Â°</option><option value="30">30Â°</option><option value="50">50Â°</option><option value="60">60Â°</option></select><div class="unit">ê¸°ë³¸ 45Â°</div></div>
            </div>
            <div style="margin-top:6px;display:flex;align-items:center;gap:8px;">
              <span style="font-size:11px;color:#94a3b8;">ì¶”ì • 1RM:</span>
              <span id="lp1rm" style="font-size:18px;font-weight:900;color:#10b981;">-</span>
              <span style="font-size:11px;color:#94a3b8;">kg</span>
              <span style="font-size:10px;color:#bbb;margin-left:4px;">(ì‹¤íš¨ <span id="lpEff">-</span>kg)</span>
            </div>
            <input type="hidden" id="mLP" value="0"/>
          </div>
          <!-- Bench Press -->
          <div style="background:white;border-radius:10px;padding:12px;border:2px solid #e8e8e8;">
            <div style="font-size:12px;font-weight:800;color:#0f172a;margin-bottom:6px;">ğŸ‹ï¸ ë²¤ì¹˜í”„ë ˆìŠ¤</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
              <div class="mi"><label>ë¬´ê²Œ</label><input id="mBPw" type="number" placeholder="60" oninput="calc1RM('BP')"><div class="unit">kg</div></div>
              <div class="mi"><label>íšŸìˆ˜</label><input id="mBPr" type="number" placeholder="8" oninput="calc1RM('BP')"><div class="unit">íšŒ</div></div>
            </div>
            <div style="margin-top:6px;display:flex;align-items:center;gap:8px;">
              <span style="font-size:11px;color:#94a3b8;">ì¶”ì • 1RM:</span>
              <span id="bp1rm" style="font-size:18px;font-weight:900;color:#10b981;">-</span>
              <span style="font-size:11px;color:#94a3b8;">kg</span>
            </div>
            <input type="hidden" id="mBP" value="0"/>
          </div>
        </div>
      </div>
      <div class="sec-label">ê·¼ì§€êµ¬ë ¥ í…ŒìŠ¤íŠ¸</div>
      <div class="mg">
        <div class="mi"><label>í‘¸ì‹œì—…</label><input id="mPU" type="number"><div class="unit">íšŒ</div></div>
        <div class="mi"><label>ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°</label><input id="mSU" type="number"><div class="unit">íšŒ/1ë¶„</div></div>
        <div class="mi"><label>ìŠ¤ì¿¼íŠ¸</label><input id="mSQ" type="number"><div class="unit">íšŒ/1ë¶„</div></div>
      </div>
      <div class="sec-label">ì‹¬í ê¸°ëŠ¥</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
        <div class="mi"><label>ì•ˆì •ì‹œ ì‹¬ë°•ìˆ˜</label><input id="mHR" type="number"><div class="unit">bpm</div></div>
        <div class="mi"><label>3ë¶„ ìŠ¤í…í…ŒìŠ¤íŠ¸</label><input id="mStep" type="number"><div class="unit">íšŒë³µì‹¬ë°•</div></div>
        <div class="mi"><label>í˜ˆì•• (ìˆ˜ì¶•ê¸°)</label><input id="mBPs" type="number"><div class="unit">mmHg</div></div>
        <div class="mi"><label>í˜ˆì•• (ì´ì™„ê¸°)</label><input id="mBPd" type="number"><div class="unit">mmHg</div></div>
      </div>
    </div>

    <button class="btn btn-primary" onclick="analyzeAndSave()" style="font-size:16px;padding:16px;">ğŸ† ë¶„ì„ ë° ì €ì¥</button>
  </div>

  <!-- TAB 1: ë¦¬í¬íŠ¸ -->
  <div class="page" id="page1">
    <div class="card" id="reportCard">
      <div class="score-hero" id="scoreHero">
        <div class="level-badge" id="lvBadge" style="background:#94a3b8;">LEVEL -</div>
        <div class="score-big"><span id="totalScore">0</span><span class="sub">/100</span></div>
        <div class="level-msg" id="lvMsg" style="color:#94a3b8;">ì¸¡ì • ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
      </div>
      <div class="radar-wrap"><canvas id="radarChart"></canvas></div>
      <table class="grade-table">
        <thead><tr><th>í•­ëª©</th><th>ìˆ˜ì¹˜</th><th>ë“±ê¸‰</th></tr></thead>
        <tbody id="gradeBody"></tbody>
      </table>
      <div class="analysis-box" id="analysisBox">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
    <button class="btn btn-cap" onclick="captureReport()">ğŸ“¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ ì €ì¥</button>
  </div>

  <!-- TAB 2: ê·¸ë˜í”„ -->
  <div class="page" id="page2">
    <div class="card">
      <div class="card-title">ğŸ‘¤ íšŒì› ì„ íƒ</div>
      <div class="ms-wrap"><input class="ms-input" id="ms2" placeholder="íšŒì› ê²€ìƒ‰..." oninput="filterMS(2)" onfocus="filterMS(2)" autocomplete="off"/><div class="ms-dd" id="mdd2"></div></div>
    </div>
    <div class="card" id="graphCard" style="display:none;">
      <div class="card-title">ğŸ“Š <span id="graphName"></span> ë³€í™” ì¶”ì´</div>
      <div class="chip-row" id="chips"></div>
      <div class="chart-wrap"><canvas id="lineChart"></canvas></div>
    </div>
    <div class="empty-msg" id="graphEmpty">íšŒì›ì„ ì„ íƒí•˜ë©´ ë³€í™” ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
  </div>

  <!-- TAB 3: ê¸°ë¡ -->
  <div class="page" id="page3">
    <div class="card">
      <div class="card-title">ğŸ‘¤ íšŒì› ì„ íƒ</div>
      <div class="ms-wrap"><input class="ms-input" id="ms3" placeholder="íšŒì› ê²€ìƒ‰..." oninput="filterMS(3)" onfocus="filterMS(3)" autocomplete="off"/><div class="ms-dd" id="mdd3"></div></div>
    </div>
    <div id="histList"></div>
    <div class="empty-msg" id="histEmpty">íšŒì›ì„ ì„ íƒí•˜ë©´ ì¸¡ì • ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
  </div>
</div>

<script>
const API='https://script.google.com/macros/s/AKfycbwI19_vVkGRszG-5CVTj03UOFaITBQfC_bdgeqIBsmoWCUN7kP86tgGShu_RzOBD3v2/exec';
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.className='toast show';setTimeout(()=>t.className='toast',2500);}
async function api(d){try{const r=await fetch(API,{method:'POST',redirect:'follow',headers:{'Content-Type':'text/plain'},body:JSON.stringify(d)});const t=await r.text();try{return JSON.parse(t);}catch(e){return{success:false,error:'ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨'};}}catch(e){return{success:false,error:e.message};}}

// â•â•â• TABS â•â•â•
function switchTab(n){document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===n));document.querySelectorAll('.page').forEach((p,i)=>p.classList.toggle('active',i===n));}

// â•â•â• MEMBERS â•â•â•
let allM=[];
async function loadM(){try{const r=await fetch(API+'?action=get_members');const d=await r.json();if(d.success)allM=d.members;}catch(e){}}
function buildDD(q,dd,cb){dd.innerHTML='';const f=q?allM.filter(m=>m.name.toLowerCase().includes(q.toLowerCase())):allM;
if(!f.length){dd.innerHTML='<div class="ms-item" style="color:#ccc;">ê²°ê³¼ ì—†ìŒ</div>';dd.classList.add('show');return;}
f.forEach(m=>{const d=document.createElement('div');d.className='ms-item';d.textContent=m.name;
d.addEventListener('mousedown',e=>{e.preventDefault();cb(m.name);});d.addEventListener('touchend',e=>{e.preventDefault();cb(m.name);});
dd.appendChild(d);});dd.classList.add('show');}
function filterMS(tab){const ids=['ms0','','ms2','ms3'];const dds=['mdd0','','mdd2','mdd3'];
buildDD(document.getElementById(ids[tab]).value,document.getElementById(dds[tab]),n=>{
document.getElementById(ids[tab]).value=n;document.getElementById(dds[tab]).classList.remove('show');
if(tab===0){document.getElementById('selMember').value=n;}
else if(tab===2){loadGraph(n);}
else if(tab===3){loadHist(n);}});}
document.addEventListener('click',e=>{document.querySelectorAll('.ms-dd').forEach(d=>{if(!e.target.closest('.ms-wrap'))d.classList.remove('show');});});
function showAddModal(){document.getElementById('newName').value='';document.getElementById('addModal').classList.add('show');setTimeout(()=>document.getElementById('newName').focus(),100);}
async function addMemberOk(){const n=document.getElementById('newName').value.trim();if(!n)return;document.getElementById('addModal').classList.remove('show');toast('â³ ë“±ë¡ì¤‘...');const r=await api({action:'add_member',member:n});if(r.success){toast('âœ… '+n+' ë“±ë¡!');loadM();document.getElementById('ms0').value=n;document.getElementById('selMember').value=n;}else toast('âŒ '+(r.error||'ì‹¤íŒ¨'));}
async function refreshAll(){toast('ğŸ“¥ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');await loadM();toast('âœ… ì™„ë£Œ!');}

// â•â•â• BMI AUTO â•â•â•
document.getElementById('mH').addEventListener('input',calcBMI);
document.getElementById('mW').addEventListener('input',calcBMI);
function calcBMI(){const h=parseFloat(document.getElementById('mH').value),w=parseFloat(document.getElementById('mW').value);document.getElementById('mBMI').value=(h>0&&w>0)?(w/((h/100)**2)).toFixed(1):'';}

// â•â•â• ê°„ì ‘ 1RM ê³„ì‚° (Brzycki ê³µì‹) â•â•â•
function calc1RM(type){
  if(type==='LP'){
    const w=parseFloat(document.getElementById('mLPw').value)||0;
    const r=parseFloat(document.getElementById('mLPr').value)||0;
    const angle=parseFloat(document.getElementById('mLPa').value)||45;
    if(w>0&&r>0){
      // Brzycki: 1RM = weight / (1.0278 - 0.0278 Ã— reps)
      const raw1rm=r===1?w:w/(1.0278-0.0278*r);
      // íŒŒì›Œ ë ˆê·¸í”„ë ˆìŠ¤ ì‹¤íš¨ í•˜ì¤‘ = í”Œë ˆì´íŠ¸ ë¬´ê²Œ Ã— sin(ê°ë„)
      const sinVal=Math.sin(angle*Math.PI/180);
      const effective=raw1rm*sinVal;
      document.getElementById('lp1rm').textContent=Math.round(raw1rm);
      document.getElementById('lpEff').textContent=Math.round(effective);
      document.getElementById('mLP').value=Math.round(effective);
    }else{
      document.getElementById('lp1rm').textContent='-';
      document.getElementById('lpEff').textContent='-';
      document.getElementById('mLP').value='0';
    }
  }else if(type==='BP'){
    const w=parseFloat(document.getElementById('mBPw').value)||0;
    const r=parseFloat(document.getElementById('mBPr').value)||0;
    if(w>0&&r>0){
      const raw1rm=r===1?w:w/(1.0278-0.0278*r);
      document.getElementById('bp1rm').textContent=Math.round(raw1rm);
      document.getElementById('mBP').value=Math.round(raw1rm);
    }else{
      document.getElementById('bp1rm').textContent='-';
      document.getElementById('mBP').value='0';
    }
  }
}
// â•â•â• ACSM â•â•â•
['ckA','ckD','ckS'].forEach(id=>document.getElementById(id).addEventListener('change',updateACSM));
function updateACSM(){const a=document.getElementById('ckA').checked,d=document.getElementById('ckD').checked,s=document.getElementById('ckS').checked;let m='',c='';
if(!a){if(!d&&!s){m='âœ… ê°€ë²¼ìš´/ì¤‘ê°•ë„ ìš´ë™ ì‹œì‘ ê°€ëŠ¥';c='safe';}else{m='âš ï¸ ì˜ë£Œì§„ ìŠ¹ì¸ í•„ìš”';c='warn';}}
else{if(s){m='ğŸš¨ ì¦‰ì‹œ ìš´ë™ ì¤‘ë‹¨, ì˜ë£Œì§„ ê²€ì‚¬ í•„ìš”';c='danger';}else if(d){m='âœ… ì¤‘ê°•ë„ ìœ ì§€ ê°€ëŠ¥ (ê³ ê°•ë„ëŠ” ìƒë‹´ ê¶Œì¥)';c='warn';}else{m='âœ… ì¤‘ê°•ë„ ë° ê³ ê°•ë„ ìš´ë™ ì§€ì† ê°€ëŠ¥';c='safe';}}
const el=document.getElementById('acsmR');el.className='acsm-result '+c;el.textContent=m;}

// â•â•â• LEVEL SYSTEM â•â•â•
const LEVELS=[
  {title:'LEVEL 1',color:'#ef4444',msg:'ì²´ë ¥ íšŒë³µì´ ìµœìš°ì„ ì…ë‹ˆë‹¤',detail:'ì „ë°˜ì  ê·¼ë ¥ê³¼ ëŒ€ì‚¬ê°€ ì €í•˜ëœ ìƒíƒœ. ê°€ë™ì„± í›ˆë ¨ë¶€í„° ì‹œì‘í•˜ì„¸ìš”.'},
  {title:'LEVEL 2',color:'#f97316',msg:'ì¼ìƒ ì²´ë ¥ì´ ë¶€ì¡±í•œ êµ¬ê°„',detail:'ì‰½ê²Œ ì§€ì¹˜ëŠ” íƒ€ì…. ì£¼ 3íšŒ ìœ ì‚°ì†Œ + ê¸°ì´ˆ ê·¼ë ¥ í›ˆë ¨ì´ ì‹œê¸‰í•©ë‹ˆë‹¤.'},
  {title:'LEVEL 3',color:'#3b82f6',msg:'ìš´ë™ íš¨ê³¼ê°€ ë‚˜íƒ€ë‚˜ê¸° ì‹œì‘',detail:'í‰ê·  ìˆ˜ì¤€. ì•½ì  ë¶€ìœ„ë¥¼ ì§‘ì¤‘ íƒ€ê²©í•˜ì—¬ ë°¸ëŸ°ìŠ¤ë¥¼ ì¡ì„ ë•Œì…ë‹ˆë‹¤.'},
  {title:'LEVEL 4',color:'#10b981',msg:'ëª¸ì´ ìš´ë™ì„ ì˜ ë°›ì•„ë“¤ì…ë‹ˆë‹¤',detail:'í›Œë¥­í•œ ì»¨ë””ì…˜. ê³ ê°•ë„ ì¸í„°ë²Œì´ë‚˜ ìŠ¤íŠ¸ë ìŠ¤ë¡œ í•œê³„ë¥¼ ëŒíŒŒí•˜ì„¸ìš”.'},
  {title:'LEVEL 5',color:'#facc15',msg:'ìµœìƒìœ„ ì²´ë ¥ ìˆ˜ì¤€ì…ë‹ˆë‹¤',detail:'ìƒìœ„ê¶Œ ì²´ë ¥. ë¶€ìƒ ë°©ì§€ì™€ ê¸°ëŠ¥ì„± íŠ¸ë ˆì´ë‹ì— ì§‘ì¤‘í•  ë‹¨ê³„ì…ë‹ˆë‹¤.'}
];

function getGrade(val,cat){
  if(cat==='lower')return val>=3.6?1:val>=2.6?3:8;
  if(cat==='upper')return val>=1.24?1:val>=0.78?3:8;
  if(cat==='endure')return val>=30?1:val>=17?3:8;
  if(cat==='cardio')return val>=49?1:val>=36?3:8;
  if(cat==='fat')return val<=13?1:val<=24?3:8;
  return 5;
}
function gradeColor(g){return g<=2?'#10b981':g<=4?'#3b82f6':g<=6?'#f97316':'#ef4444';}

let radarChart=null;
function updateReport(result){
  const lv=LEVELS[result.lvIdx];
  document.getElementById('totalScore').textContent=result.total;
  const badge=document.getElementById('lvBadge');badge.textContent=lv.title;badge.style.background=lv.color;
  const msg=document.getElementById('lvMsg');msg.textContent=lv.msg;msg.style.color=lv.color;
  // Grade table
  const cats=['í•˜ì²´ ê·¼ë ¥','ìƒì²´ ê·¼ë ¥','ê·¼ì§€êµ¬ë ¥','ì‹¬í íšŒë³µë ¥','ì²´ì§€ë°©'];
  let html='';
  result.labels.forEach((l,i)=>{const c=gradeColor(result.grades[i]);html+=`<tr><td style="font-weight:700">${cats[i]}</td><td>${l}</td><td><span class="grade-pill" style="background:${c}">${result.grades[i]}ë“±ê¸‰</span></td></tr>`;});
  document.getElementById('gradeBody').innerHTML=html;
  // Analysis
  document.getElementById('analysisBox').innerHTML=result.analysis||('<strong>[ì´í‰]</strong> '+lv.detail);
  // Radar
  const ctx=document.getElementById('radarChart');
  if(radarChart)radarChart.destroy();
  radarChart=new Chart(ctx,{type:'radar',data:{labels:['í•˜ì²´','ìƒì²´','ì§€êµ¬ë ¥','ì‹¬ííšŒë³µ','ì²´ì§€ë°©'],
  datasets:[{data:result.grades.map(g=>10-g),backgroundColor:lv.color+'33',borderColor:lv.color,borderWidth:3,pointRadius:5}]},
  options:{scales:{r:{min:0,max:10,ticks:{display:false},pointLabels:{font:{size:14,weight:'bold',family:'Noto Sans KR'}}}},plugins:{legend:{display:false}}}});
  switchTab(1);
}

// â•â•â• ANALYZE & SAVE â•â•â•
async function analyzeAndSave(){
  const member=document.getElementById('selMember').value;
  if(!member){toast('âš ï¸ íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”!');return;}
  const w=parseFloat(document.getElementById('mW').value)||70;
  const lp=parseFloat(document.getElementById('mLP').value)||0;
  const bp=parseFloat(document.getElementById('mBP').value)||0;
  const pu=parseFloat(document.getElementById('mPU').value)||0;
  const stepHR=parseFloat(document.getElementById('mStep').value)||0;
  const bf=parseFloat(document.getElementById('mBF').value)||0;
  const lRatio=w>0?(lp/w):0;const uRatio=w>0?(bp/w):0;
  // Cardio: step test recovery HR (lower=better). <100=excellent, 100-120=good, >120=poor
  function getStepGrade(hr){if(hr<=0)return 5;return hr<=100?1:hr<=110?2:hr<=120?3:hr<=130?5:8;}
  const grades=[getGrade(lRatio,'lower'),getGrade(uRatio,'upper'),getGrade(pu,'endure'),getStepGrade(stepHR),getGrade(bf,'fat')];
  const points=grades.map(g=>22-(g*2));
  const total=Math.max(0,Math.min(100,points.reduce((a,b)=>a+b,0)));
  const lvIdx=Math.min(Math.floor(total/20.01),4);
  const labels=[lRatio.toFixed(2)+'ë°°',uRatio.toFixed(2)+'ë°°',pu+'íšŒ',stepHR?stepHR+'bpm':'-',bf+'%'];
  const acsm=document.getElementById('acsmR').textContent;

  // Professional analysis
  const age=parseInt(document.getElementById('mAge').value)||30;
  const gender=document.getElementById('mGender').value;
  const bmi=parseFloat(document.getElementById('mBMI').value)||0;
  const smm=parseFloat(document.getElementById('mSMM').value)||0;
  const waist=parseFloat(document.getElementById('mWaist').value)||0;
  const su=parseFloat(document.getElementById('mSU').value)||0;
  const sq=parseFloat(document.getElementById('mSQ').value)||0;
  const hr=parseFloat(document.getElementById('mHR').value)||0;
  const bps=parseFloat(document.getElementById('mBPs').value)||0;
  const bpd=parseFloat(document.getElementById('mBPd').value)||0;

  let analysis='';
  // Body composition
  analysis+='<div style="margin-bottom:12px;"><b>ğŸ”¬ ì²´ì„±ë¶„ ë¶„ì„</b><br>';
  if(bmi>0){
    if(bmi<18.5)analysis+='BMI '+bmi+'ë¡œ <span style="color:#3b82f6">ì €ì²´ì¤‘</span>ì…ë‹ˆë‹¤. ê·¼ìœ¡ëŸ‰ ì¦ê°€ë¥¼ ìœ„í•œ ì ì§„ì  ì €í•­ ìš´ë™ê³¼ ë‹¨ë°±ì§ˆ ì„­ì·¨(ì²´ì¤‘ 1kgë‹¹ 1.6~2.2g)ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.<br>';
    else if(bmi<23)analysis+='BMI '+bmi+'ë¡œ <span style="color:#10b981">ì •ìƒ ë²”ìœ„</span>ì…ë‹ˆë‹¤. í˜„ì¬ ì²´ì¤‘ì„ ìœ ì§€í•˜ë©´ì„œ ì²´ì§€ë°© ëŒ€ë¹„ ê·¼ìœ¡ëŸ‰ ë¹„ìœ¨ ê°œì„ ì— ì§‘ì¤‘í•˜ì„¸ìš”.<br>';
    else if(bmi<25)analysis+='BMI '+bmi+'ë¡œ <span style="color:#f97316">ê³¼ì²´ì¤‘ ê²½ê³„</span>ì…ë‹ˆë‹¤. ì£¼ 3~4íšŒ ìœ ì‚°ì†Œ ìš´ë™(30ë¶„ ì´ìƒ)ê³¼ ì‹ì´ ê´€ë¦¬ë¥¼ ë³‘í–‰í•˜ì„¸ìš”.<br>';
    else analysis+='BMI '+bmi+'ë¡œ <span style="color:#ef4444">ë¹„ë§Œ êµ¬ê°„</span>ì…ë‹ˆë‹¤. ê´€ì ˆ ë¶€ë‹´ì„ ì¤„ì´ëŠ” ì €ì¶©ê²© ìœ ì‚°ì†Œ(ìˆ˜ì˜, ìì „ê±°)ë¶€í„° ì‹œì‘í•˜ê³ , ì „ë¬¸ ì˜ì–‘ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.<br>';
  }
  if(bf>0){
    const bfStd=gender==='ë‚¨'?{good:15,avg:20,high:25}:{good:22,avg:28,high:33};
    if(bf<=bfStd.good)analysis+='ì²´ì§€ë°©ë¥  '+bf+'%ë¡œ '+gender+'ì„± ê¸°ì¤€ <span style="color:#10b981">ìš°ìˆ˜</span>í•©ë‹ˆë‹¤. ê·¼ë ¥ íŠ¸ë ˆì´ë‹ ìœ„ì£¼ë¡œ ì§„í–‰í•˜ì„¸ìš”.<br>';
    else if(bf<=bfStd.avg)analysis+='ì²´ì§€ë°©ë¥  '+bf+'%ë¡œ '+gender+'ì„± ê¸°ì¤€ <span style="color:#3b82f6">í‘œì¤€</span>ì…ë‹ˆë‹¤. ìœ ì‚°ì†Œ+ê·¼ë ¥ ë³‘í–‰ìœ¼ë¡œ ì²´ì§€ë°© ê°ì†Œë¥¼ ë…¸ë ¤ë³´ì„¸ìš”.<br>';
    else if(bf<=bfStd.high)analysis+='ì²´ì§€ë°©ë¥  '+bf+'%ë¡œ '+gender+'ì„± ê¸°ì¤€ <span style="color:#f97316">í‘œì¤€ ì´ìƒ</span>ì…ë‹ˆë‹¤. ì£¼ 4íšŒ ì´ìƒ ì¤‘ê°•ë„ ìœ ì‚°ì†Œ ìš´ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>';
    else analysis+='ì²´ì§€ë°©ë¥  '+bf+'%ë¡œ '+gender+'ì„± ê¸°ì¤€ <span style="color:#ef4444">ë†’ìŒ</span>ì…ë‹ˆë‹¤. ì‹ì´ìš”ë²•ê³¼ ì €ê°•ë„ ìœ ì‚°ì†Œë¥¼ ìš°ì„  ì‹¤ì‹œí•˜ê³  ì ì§„ì ìœ¼ë¡œ ê°•ë„ë¥¼ ë†’ì´ì„¸ìš”.<br>';
  }
  if(waist>0){
    const waistRisk=gender==='ë‚¨'?90:85;
    if(waist>=waistRisk)analysis+='í—ˆë¦¬ë‘˜ë ˆ '+waist+'cmë¡œ '+gender+'ì„± ë³µë¶€ë¹„ë§Œ ê¸°ì¤€('+waistRisk+'cm)ì„ <span style="color:#ef4444">ì´ˆê³¼</span>í•©ë‹ˆë‹¤. ë‚´ì¥ì§€ë°© ê°ì†Œë¥¼ ìœ„í•œ ìœ ì‚°ì†Œ ìš´ë™ê³¼ ì‹ì´ì¡°ì ˆì´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.<br>';
    else analysis+='í—ˆë¦¬ë‘˜ë ˆ '+waist+'cmë¡œ ë³µë¶€ë¹„ë§Œ ê¸°ì¤€ ì´ë‚´ì…ë‹ˆë‹¤.<br>';
  }
  analysis+='</div>';

  // Strength
  analysis+='<div style="margin-bottom:12px;"><b>ğŸ’ª ê·¼ë ¥ í‰ê°€</b><br>';
  if(lRatio>0){
    if(lRatio>=3.6)analysis+='í•˜ì²´ ê·¼ë ¥ ë¹„ìœ¨ '+lRatio.toFixed(2)+'ë°° â€” <span style="color:#10b981">ë§¤ìš° ìš°ìˆ˜</span>. ACSM ê¸°ì¤€ ìƒìœ„ ìˆ˜ì¤€ì…ë‹ˆë‹¤.<br>';
    else if(lRatio>=2.6)analysis+='í•˜ì²´ ê·¼ë ¥ ë¹„ìœ¨ '+lRatio.toFixed(2)+'ë°° â€” <span style="color:#3b82f6">í‘œì¤€</span>. ìŠ¤ì¿¼íŠ¸, ëŸ°ì§€ ë“± ë³µí•©ìš´ë™ìœ¼ë¡œ í•˜ì²´ ê°•í™”ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.<br>';
    else analysis+='í•˜ì²´ ê·¼ë ¥ ë¹„ìœ¨ '+lRatio.toFixed(2)+'ë°° â€” <span style="color:#ef4444">ê¸°ì¤€ ì´í•˜</span>. ë ˆê·¸í”„ë ˆìŠ¤, ë ˆê·¸ìµìŠ¤í…ì…˜ ë“± ê¸°ì´ˆ í•˜ì²´ ìš´ë™ë¶€í„° ì‹œì‘í•˜ì„¸ìš”. ë¬´ë¦ ì •ë ¬ì— ì£¼ì˜í•˜ë©° ì ì§„ì ìœ¼ë¡œ ì¤‘ëŸ‰ì„ ì˜¬ë¦¬ì„¸ìš”.<br>';
  }
  if(uRatio>0){
    if(uRatio>=1.24)analysis+='ìƒì²´ ê·¼ë ¥ ë¹„ìœ¨ '+uRatio.toFixed(2)+'ë°° â€” <span style="color:#10b981">ë§¤ìš° ìš°ìˆ˜</span>.<br>';
    else if(uRatio>=0.78)analysis+='ìƒì²´ ê·¼ë ¥ ë¹„ìœ¨ '+uRatio.toFixed(2)+'ë°° â€” <span style="color:#3b82f6">í‘œì¤€</span>. ë²¤ì¹˜í”„ë ˆìŠ¤ì™€ ë¡œìš° ê³„ì—´ ìš´ë™ìœ¼ë¡œ ìƒì²´ ê· í˜• ë°œë‹¬ì„ ì¶”ì²œí•©ë‹ˆë‹¤.<br>';
    else analysis+='ìƒì²´ ê·¼ë ¥ ë¹„ìœ¨ '+uRatio.toFixed(2)+'ë°° â€” <span style="color:#ef4444">ê¸°ì¤€ ì´í•˜</span>. í‘¸ì‹œì—…, ë¤ë²¨í”„ë ˆìŠ¤ ë“± ê¸°ì´ˆ ìƒì²´ ìš´ë™ë¶€í„° ì‹œì‘í•˜ì„¸ìš”. ê²¬ê°‘ê³¨ ì•ˆì •ì„± í™•ë³´ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.<br>';
  }
  analysis+='</div>';

  // Endurance
  analysis+='<div style="margin-bottom:12px;"><b>ğŸƒ ê·¼ì§€êµ¬ë ¥ í‰ê°€</b><br>';
  if(pu>0){
    if(pu>=30)analysis+='í‘¸ì‹œì—… '+pu+'íšŒ â€” <span style="color:#10b981">ìš°ìˆ˜</span>. ìƒì²´ ê·¼ì§€êµ¬ë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.<br>';
    else if(pu>=17)analysis+='í‘¸ì‹œì—… '+pu+'íšŒ â€” <span style="color:#3b82f6">ë³´í†µ</span>. ë§¤ì¼ 3ì„¸íŠ¸ì”© ê¾¸ì¤€íˆ í•˜ë©´ ë¹ ë¥´ê²Œ í–¥ìƒë©ë‹ˆë‹¤.<br>';
    else analysis+='í‘¸ì‹œì—… '+pu+'íšŒ â€” <span style="color:#ef4444">ë¶€ì¡±</span>. ë¬´ë¦ í‘¸ì‹œì—…ì´ë‚˜ ì¸í´ë¼ì¸ í‘¸ì‹œì—…ë¶€í„° ì‹œì‘í•˜ì—¬ ê·¼ì§€êµ¬ë ¥ì„ í‚¤ìš°ì„¸ìš”.<br>';
  }
  if(su>0)analysis+='ìœ—ëª¸ì¼ìœ¼í‚¤ê¸° '+su+'íšŒ/ë¶„'+(su>=25?' â€” ì–‘í˜¸':su>=15?' â€” ë³´í†µ':' â€” ì½”ì–´ ê°•í™” í•„ìš”')+'<br>';
  if(sq>0)analysis+='ìŠ¤ì¿¼íŠ¸ '+sq+'íšŒ/ë¶„'+(sq>=30?' â€” ìš°ìˆ˜':sq>=20?' â€” ë³´í†µ':' â€” í•˜ì²´ ì§€êµ¬ë ¥ í–¥ìƒ í•„ìš”')+'<br>';
  analysis+='</div>';

  // Cardio
  analysis+='<div style="margin-bottom:12px;"><b>â¤ï¸ ì‹¬í ê¸°ëŠ¥ í‰ê°€</b><br>';
  if(hr>0){
    if(hr<=60)analysis+='ì•ˆì •ì‹œ ì‹¬ë°•ìˆ˜ '+hr+'bpm â€” <span style="color:#10b981">ë§¤ìš° ì–‘í˜¸</span>. ì‹¬í ê¸°ëŠ¥ì´ ìš°ìˆ˜í•©ë‹ˆë‹¤.<br>';
    else if(hr<=75)analysis+='ì•ˆì •ì‹œ ì‹¬ë°•ìˆ˜ '+hr+'bpm â€” <span style="color:#3b82f6">ì •ìƒ</span>.<br>';
    else analysis+='ì•ˆì •ì‹œ ì‹¬ë°•ìˆ˜ '+hr+'bpm â€” <span style="color:#f97316">ë‹¤ì†Œ ë†’ìŒ</span>. ê·œì¹™ì ì¸ ìœ ì‚°ì†Œ ìš´ë™ìœ¼ë¡œ ì‹¬í ê¸°ëŠ¥ì„ í–¥ìƒì‹œí‚¤ì„¸ìš”.<br>';
  }
  if(bps>0&&bpd>0){
    if(bps<120&&bpd<80)analysis+='í˜ˆì•• '+bps+'/'+bpd+'mmHg â€” <span style="color:#10b981">ì •ìƒ</span>.<br>';
    else if(bps<140&&bpd<90)analysis+='í˜ˆì•• '+bps+'/'+bpd+'mmHg â€” <span style="color:#f97316">ì£¼ì˜ ë‹¨ê³„(ê³ í˜ˆì•• ì „ë‹¨ê³„)</span>. ë‚˜íŠ¸ë¥¨ ì„­ì·¨ë¥¼ ì¤„ì´ê³  ìœ ì‚°ì†Œ ìš´ë™ì„ ê·œì¹™ì ìœ¼ë¡œ í•˜ì„¸ìš”.<br>';
    else analysis+='í˜ˆì•• '+bps+'/'+bpd+'mmHg â€” <span style="color:#ef4444">ë†’ìŒ</span>. ì˜ë£Œì§„ ìƒë‹´ í›„ ìš´ë™ í”„ë¡œê·¸ë¨ì„ ì„¤ê³„í•˜ì„¸ìš”. ê³ ê°•ë„ ìš´ë™ì€ í”¼í•˜ì„¸ìš”.<br>';
  }
  if(stepHR>0){
    if(stepHR<=100)analysis+='ìŠ¤í…í…ŒìŠ¤íŠ¸ íšŒë³µì‹¬ë°• '+stepHR+'bpm â€” <span style="color:#10b981">ìš°ìˆ˜</span>. ì‹¬í íšŒë³µë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.<br>';
    else if(stepHR<=120)analysis+='ìŠ¤í…í…ŒìŠ¤íŠ¸ íšŒë³µì‹¬ë°• '+stepHR+'bpm â€” <span style="color:#3b82f6">ë³´í†µ</span>. ì£¼ 3íšŒ ì´ìƒ 30ë¶„ ìœ ì‚°ì†Œë¡œ ê°œì„  ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>';
    else analysis+='ìŠ¤í…í…ŒìŠ¤íŠ¸ íšŒë³µì‹¬ë°• '+stepHR+'bpm â€” <span style="color:#ef4444">ë‚®ìŒ</span>. ì‹¬í ê¸°ëŠ¥ í–¥ìƒì„ ìœ„í•´ ê±·ê¸°ë¶€í„° ì‹œì‘í•˜ì—¬ ì ì§„ì ìœ¼ë¡œ ê°•ë„ë¥¼ ë†’ì´ì„¸ìš”.<br>';
  }
  analysis+='</div>';

  // Recommendation
  analysis+='<div><b>ğŸ“‹ ì¢…í•© ìš´ë™ ì²˜ë°©</b><br>';
  const lv=LEVELS[lvIdx];
  analysis+=lv.detail+'<br>';
  if(lvIdx<=1)analysis+='<br>ğŸ”¸ <b>ê¶Œì¥ í”„ë¡œê·¸ë¨:</b> ì£¼ 3íšŒ, ì „ì‹  ê·¼ë ¥ìš´ë™(ë¨¸ì‹  ìœ„ì£¼) + ê±·ê¸° 30ë¶„. 2ì£¼ë§ˆë‹¤ ê°•ë„ 10% ì¦ê°€.';
  else if(lvIdx===2)analysis+='<br>ğŸ”¸ <b>ê¶Œì¥ í”„ë¡œê·¸ë¨:</b> ì£¼ 4íšŒ, ë¶„í•  ê·¼ë ¥ìš´ë™(ìƒ/í•˜ì²´) + ì¤‘ê°•ë„ ìœ ì‚°ì†Œ 30~40ë¶„. ì•½ì  ë¶€ìœ„ ì§‘ì¤‘ ë³´ê°•.';
  else if(lvIdx===3)analysis+='<br>ğŸ”¸ <b>ê¶Œì¥ í”„ë¡œê·¸ë¨:</b> ì£¼ 4~5íšŒ, ê³ ê°•ë„ ì¸í„°ë²Œ(HIIT) + ìŠ¤íŠ¸ë ìŠ¤ í›ˆë ¨. ì£¼ê¸°í™” í”„ë¡œê·¸ë˜ë° ì ìš© ê¶Œì¥.';
  else analysis+='<br>ğŸ”¸ <b>ê¶Œì¥ í”„ë¡œê·¸ë¨:</b> ì£¼ 5~6íšŒ, ê¸°ëŠ¥ì„± í›ˆë ¨ + ìŠ¤í¬ì¸  íŠ¹ì´ì„± í›ˆë ¨. íšŒë³µ ì „ëµ(ì˜ì–‘, ìˆ˜ë©´) ìµœì í™”ì— ì§‘ì¤‘.';
  analysis+='</div>';

  const result={total,lvIdx,grades,labels,acsm,analysis,extra:{weight:document.getElementById('mW').value,bf:document.getElementById('mBF').value,smm:document.getElementById('mSMM').value,bmi:document.getElementById('mBMI').value}};
  updateReport(result);
  // Save
  toast('â³ ì €ì¥ì¤‘...');
  const data={action:'save_eval',member,date:new Date().toLocaleDateString('ko-KR'),
    age:document.getElementById('mAge').value,gender:document.getElementById('mGender').value,
    height:document.getElementById('mH').value,weight:document.getElementById('mW').value,
    bf:document.getElementById('mBF').value,smm:document.getElementById('mSMM').value,
    bmi:document.getElementById('mBMI').value,waist:document.getElementById('mWaist').value,
    pushup:document.getElementById('mPU').value,situp:document.getElementById('mSU').value,
    squat:document.getElementById('mSQ').value,
    hr:document.getElementById('mHR').value,bps:document.getElementById('mBPs').value,bpd:document.getElementById('mBPd').value,
    step:document.getElementById('mStep').value,
    legpress:document.getElementById('mLP').value,bench:document.getElementById('mBP').value,
    lpWeight:document.getElementById('mLPw').value,lpReps:document.getElementById('mLPr').value,lpAngle:document.getElementById('mLPa').value,
    bpWeight:document.getElementById('mBPw').value,bpReps:document.getElementById('mBPr').value,
    totalScore:total,level:LEVELS[lvIdx].title,acsm,analysisHtml:analysis};
  const r=await api(data);
  if(r.success)toast('âœ… ì €ì¥ ì™„ë£Œ!');else toast('âŒ '+(r.error||'ì‹¤íŒ¨'));
}

// â•â•â• CAPTURE â•â•â•
async function captureReport(){
  toast('â³ ìº¡ì²˜ì¤‘...');
  const el=document.getElementById('reportCard');
  const canvas=await html2canvas(el,{scale:2,backgroundColor:'#ffffff'});
  canvas.toBlob(blob=>{const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='ì²´ë ¥ì¸¡ì •_ë¦¬í¬íŠ¸.png';a.click();
  if(navigator.share&&navigator.canShare){const f=new File([blob],'ë¦¬í¬íŠ¸.png',{type:'image/png'});if(navigator.canShare({files:[f]}))navigator.share({files:[f]}).catch(()=>{});}
  toast('âœ… ì´ë¯¸ì§€ ì €ì¥!');},'image/png');
}

// â•â•â• GRAPH â•â•â•
const MET=[
  {key:'weight',label:'ì²´ì¤‘',unit:'kg',color:'#ef4444'},{key:'bf',label:'ì²´ì§€ë°©ë¥ ',unit:'%',color:'#FF9800'},
  {key:'smm',label:'ê³¨ê²©ê·¼ëŸ‰',unit:'kg',color:'#2196F3'},{key:'bmi',label:'BMI',unit:'',color:'#9C27B0'},
  {key:'pushup',label:'í‘¸ì‹œì—…',unit:'íšŒ',color:'#4CAF50'},{key:'situp',label:'ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°',unit:'íšŒ',color:'#8BC34A'},
  {key:'squat',label:'ìŠ¤ì¿¼íŠ¸',unit:'íšŒ',color:'#FF5722'},
  {key:'waist',label:'í—ˆë¦¬ë‘˜ë ˆ',unit:'cm',color:'#F44336'},{key:'hr',label:'ì‹¬ë°•ìˆ˜',unit:'bpm',color:'#607D8B'},
  {key:'totalScore',label:'ì¢…í•©ì ìˆ˜',unit:'ì ',color:'#0f172a'}
];
let lineChart=null,gData=[],activeM=['weight','bf','smm','totalScore'];
function renderChips(){const c=document.getElementById('chips');c.innerHTML='';MET.forEach(m=>{const ch=document.createElement('button');ch.className='chip'+(activeM.includes(m.key)?' on':'');
if(activeM.includes(m.key)){ch.style.borderColor=m.color;ch.style.background=m.color;ch.style.color='white';}
ch.textContent=m.label;ch.onclick=()=>{if(activeM.includes(m.key))activeM=activeM.filter(k=>k!==m.key);else activeM.push(m.key);renderChips();renderLine();};c.appendChild(ch);});}
function renderLine(){const ctx=document.getElementById('lineChart');if(lineChart)lineChart.destroy();
const labels=gData.map(d=>d.date);const ds=activeM.map(key=>{const m=MET.find(x=>x.key===key);return{label:m.label,data:gData.map(d=>parseFloat(d[key])||0),borderColor:m.color,backgroundColor:m.color+'33',tension:0.3,pointRadius:5,borderWidth:2.5,fill:false};});
lineChart=new Chart(ctx,{type:'line',data:{labels,datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{family:'Noto Sans KR',weight:'bold',size:10},usePointStyle:true}}},scales:{y:{beginAtZero:false,grid:{color:'#f0f0f0'}},x:{grid:{display:false}}}}});}
async function loadGraph(name){document.getElementById('graphEmpty').style.display='none';document.getElementById('graphCard').style.display='block';document.getElementById('graphName').textContent=name+'ë‹˜';
try{const r=await fetch(API+'?action=get_evals&member='+encodeURIComponent(name));const d=await r.json();if(d.success){gData=d.evals||[];renderChips();renderLine();}}catch(e){toast('âŒ ë¡œë“œ ì‹¤íŒ¨');}}

// â•â•â• HISTORY â•â•â•
async function loadHist(name){document.getElementById('histEmpty').style.display='none';const list=document.getElementById('histList');list.innerHTML='';
try{const r=await fetch(API+'?action=get_evals&member='+encodeURIComponent(name));const d=await r.json();if(d.success){const evals=d.evals||[];
if(!evals.length){list.innerHTML='<div class="empty-msg">ì¸¡ì • ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}
evals.forEach((ev,i)=>{const sc=ev.totalScore||'-';const lv=ev.level||'';const c=document.createElement('div');c.className='hist-card';
c.innerHTML=`<div class="hist-score" style="color:${sc>=80?'#10b981':sc>=60?'#3b82f6':sc>=40?'#f97316':'#ef4444'}">${sc}</div><div class="hist-info"><div class="hist-date">${i+1}íšŒì°¨ â€” ${ev.date}</div><div class="hist-sub">${lv} | ì²´ì¤‘:${ev.weight||'-'}kg ì²´ì§€ë°©:${ev.bf||'-'}%</div></div>`;
c.onclick=()=>showDetail(ev,i);list.appendChild(c);});}}catch(e){toast('âŒ ë¡œë“œ ì‹¤íŒ¨');}}
function showDetail(ev,i){document.getElementById('detailTitle').textContent=(i+1)+'íšŒì°¨ ('+ev.date+')';
let h=`<table style="width:100%;font-size:12px;"><tr><td><b>ì²´ì¤‘</b></td><td>${ev.weight||'-'}kg</td><td><b>ì²´ì§€ë°©</b></td><td>${ev.bf||'-'}%</td></tr>`;
h+=`<tr><td><b>ê³¨ê²©ê·¼</b></td><td>${ev.smm||'-'}kg</td><td><b>BMI</b></td><td>${ev.bmi||'-'}</td></tr>`;
h+=`<tr><td><b>í—ˆë¦¬</b></td><td>${ev.waist||'-'}cm</td><td><b>ì¢…í•©</b></td><td><b style="color:${(ev.totalScore||0)>=60?'#10b981':'#ef4444'}">${ev.totalScore||'-'}ì </b></td></tr></table><hr style="margin:8px 0;">`;
h+=`<b>ë ˆê·¸í”„ë ˆìŠ¤ 1RM:</b> ${ev.legpress||'-'}kg`;
if(ev.lpWeight)h+=` (${ev.lpWeight}kgÃ—${ev.lpReps}íšŒ, ${ev.lpAngle||45}Â°)`;
h+=`<br><b>ë²¤ì¹˜í”„ë ˆìŠ¤ 1RM:</b> ${ev.bench||'-'}kg`;
if(ev.bpWeight)h+=` (${ev.bpWeight}kgÃ—${ev.bpReps}íšŒ)`;
h+=`<br><b>í‘¸ì‹œì—…:</b> ${ev.pushup||'-'}íšŒ | <b>ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°:</b> ${ev.situp||'-'}íšŒ | <b>ìŠ¤ì¿¼íŠ¸:</b> ${ev.squat||'-'}íšŒ<br>`;
h+=`<b>ì‹¬ë°•:</b> ${ev.hr||'-'}bpm | <b>í˜ˆì••:</b> ${ev.bps||'-'}/${ev.bpd||'-'} | <b>ìŠ¤í…:</b> ${ev.step||'-'}bpm<br>`;
h+=`<b>ACSM:</b> ${ev.acsm||'-'}`;
if(ev.analysisHtml){h+=`<hr style="margin:10px 0;"><div style="font-size:12px;line-height:1.6;">${ev.analysisHtml}</div>`;}
document.getElementById('detailContent').innerHTML=h;document.getElementById('detailModal').classList.add('show');}
document.getElementById('detailContent').innerHTML=h;document.getElementById('detailModal').classList.add('show');}

// â•â•â• INIT â•â•â•
loadM();
</script>
</body>
</html>
