<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="ì²´ë ¥ì¸¡ì •">
<title>ì²´ë ¥ì¸¡ì •í‰ê°€ - BODY SPECTRUM</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans KR',sans-serif;background:#f0f2f5;padding:10px 10px 90px;-webkit-user-select:none;user-select:none;}
.container{max-width:780px;margin:0 auto;}

/* Header */
.app-header{background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);border-radius:16px;padding:20px 24px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}
.app-header h1{color:white;font-size:22px;font-weight:900;letter-spacing:-0.5px;}
.app-header h1 span{color:#00d4aa;}
.logo-sm{color:#888;font-size:12px;font-weight:700;}

/* Tabs */
.tabs{display:flex;gap:4px;margin-bottom:12px;background:#e0e0e0;border-radius:12px;padding:4px;}
.tab{flex:1;padding:10px;border:none;border-radius:10px;background:transparent;font-size:13px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;color:#888;transition:all 0.2s;}
.tab.active{background:white;color:#1a1a1a;box-shadow:0 2px 8px rgba(0,0,0,0.1);}

/* Cards */
.card{background:white;border-radius:14px;padding:20px;margin-bottom:12px;box-shadow:0 2px 12px rgba(0,0,0,0.06);}
.card-title{font-size:15px;font-weight:800;color:#1a1a1a;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.card-title .icon{font-size:18px;}

/* Form */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.form-group{display:flex;flex-direction:column;gap:4px;}
.form-group label{font-size:11px;font-weight:700;color:#888;letter-spacing:0.5px;}
.form-input{padding:10px 12px;border:2px solid #e8e8e8;border-radius:10px;font-size:14px;font-weight:600;font-family:'Noto Sans KR',sans-serif;outline:none;color:#333;transition:border 0.2s;}
.form-input:focus{border-color:#00d4aa;}
.form-input::placeholder{color:#ccc;}
select.form-input{cursor:pointer;appearance:none;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M6 8L0 0h12z' fill='%23999'/%3E%3C/svg%3E") no-repeat right 12px center white;}

/* Member search */
.member-search-wrap{position:relative;}
.member-search{width:100%;padding:10px 12px;border:2px solid #e8e8e8;border-radius:10px;font-size:14px;font-weight:600;font-family:'Noto Sans KR',sans-serif;outline:none;color:#333;}
.member-search:focus{border-color:#00d4aa;}
.member-dd{position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #e8e8e8;border-top:none;border-radius:0 0 10px 10px;max-height:180px;overflow-y:auto;z-index:100;display:none;}
.member-dd.show{display:block;}
.member-dd-item{padding:10px 12px;font-size:13px;font-weight:600;cursor:pointer;color:#555;}
.member-dd-item:hover{background:#00d4aa;color:white;}

/* ACSM */
.acsm-check{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;margin-bottom:8px;background:#f8f9fa;cursor:pointer;}
.acsm-check input[type=checkbox]{width:20px;height:20px;accent-color:#00d4aa;cursor:pointer;}
.acsm-check span{font-size:13px;font-weight:600;color:#444;}
.acsm-result{padding:14px 16px;border-radius:12px;font-size:14px;font-weight:700;line-height:1.5;margin-top:10px;}
.acsm-result.safe{background:#e8f5e9;color:#2e7d32;border:2px solid #a5d6a7;}
.acsm-result.warn{background:#fff3e0;color:#e65100;border:2px solid #ffcc80;}
.acsm-result.danger{background:#ffebee;color:#c62828;border:2px solid #ef9a9a;}

/* Measurement sections */
.section-label{font-size:12px;font-weight:800;color:white;background:#1a1a1a;display:inline-block;padding:4px 12px;border-radius:6px;margin-bottom:10px;letter-spacing:1px;}
.measure-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.measure-item{background:#f8f9fa;border-radius:10px;padding:10px;text-align:center;}
.measure-item label{font-size:10px;font-weight:700;color:#888;display:block;margin-bottom:4px;}
.measure-item input{width:100%;text-align:center;padding:6px;border:2px solid #e8e8e8;border-radius:8px;font-size:15px;font-weight:700;font-family:'Noto Sans KR',sans-serif;outline:none;color:#333;}
.measure-item input:focus{border-color:#00d4aa;}
.measure-item .unit{font-size:10px;color:#aaa;margin-top:2px;}

/* Buttons */
.btn{padding:12px 24px;border:none;border-radius:12px;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;transition:all 0.2s;width:100%;}
.btn-primary{background:#00d4aa;color:#111;}
.btn-primary:hover{background:#00b894;}
.btn-save{background:#4CAF50;color:white;}
.btn-save:hover{background:#388E3C;}
.btn-danger{background:#e53935;color:white;}
.btn-row{display:flex;gap:8px;}

/* Graph */
.chart-wrap{position:relative;height:280px;margin:10px 0;}
.chart-select{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px;}
.chip{padding:6px 12px;border-radius:20px;border:2px solid #e0e0e0;background:white;font-size:11px;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;color:#888;transition:all 0.15s;}
.chip.active{border-color:#00d4aa;background:#00d4aa;color:#111;}

/* History */
.hist-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:#f8f9fa;margin-bottom:6px;cursor:pointer;transition:background 0.15s;}
.hist-item:hover{background:#e8f5e9;}
.hist-item.active{background:#00d4aa20;border:2px solid #00d4aa;}
.hist-date{font-size:13px;font-weight:700;color:#333;}
.hist-bmi{font-size:12px;color:#888;}
.hist-del{width:24px;height:24px;border:none;border-radius:50%;background:transparent;color:#ccc;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.hist-del:hover{background:#e53935;color:white;}

/* Toast */
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:white;padding:16px 28px;border-radius:14px;font-size:15px;font-weight:600;z-index:9999;display:none;text-align:center;}
.toast.show{display:block;animation:fadeInOut 2.5s ease;}
@keyframes fadeInOut{0%{opacity:0;transform:translate(-50%,-50%) scale(0.9);}15%{opacity:1;transform:translate(-50%,-50%) scale(1);}75%{opacity:1;}100%{opacity:0;}}

/* Toolbar */
.toolbar{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:6px;background:rgba(30,30,30,0.95);padding:8px 14px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.4);z-index:500;}
.tb{padding:8px 16px;border-radius:8px;border:1px solid #444;background:transparent;color:white;font-size:12px;font-weight:600;font-family:'Noto Sans KR',sans-serif;cursor:pointer;white-space:nowrap;transition:all 0.2s;}
.tb:hover{background:#00d4aa;color:#111;border-color:#00d4aa;}
.tb.active{background:#00d4aa;color:#111;border-color:#00d4aa;}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:8000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.show{display:flex;}
.modal-box{background:white;border-radius:16px;padding:24px;width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.3);}
.modal-title{font-size:16px;font-weight:800;color:#1a1a1a;margin-bottom:12px;}
.modal-input{width:100%;padding:12px 14px;border:2px solid #ddd;border-radius:10px;font-size:15px;font-family:'Noto Sans KR',sans-serif;font-weight:600;outline:none;margin-bottom:14px;}
.modal-input:focus{border-color:#00d4aa;}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;}
.modal-btn{padding:10px 20px;border-radius:10px;border:none;font-size:13px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;}
.modal-btn.cancel{background:#f0f0f0;color:#666;}
.modal-btn.ok{background:#00d4aa;color:#111;}

.page{display:none;}.page.active{display:block;}
.empty-msg{text-align:center;padding:30px;color:#bbb;font-size:13px;font-weight:600;}
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="addModal">
  <div class="modal-box">
    <div class="modal-title">ìƒˆ íšŒì› ë“±ë¡</div>
    <input class="modal-input" id="newMemberName" placeholder="íšŒì› ì´ë¦„" autocomplete="off" onkeydown="if(event.key==='Enter')addMemberConfirm()"/>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="document.getElementById('addModal').classList.remove('show')">ì·¨ì†Œ</button>
      <button class="modal-btn ok" onclick="addMemberConfirm()">ë“±ë¡</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="app-header">
    <h1>ğŸ‹ï¸ ì²´ë ¥ì¸¡ì •<span>í‰ê°€</span></h1>
    <div class="logo-sm">BODY SPECTRUM</div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab(0)">ğŸ“‹ ì¸¡ì •í•˜ê¸°</button>
    <button class="tab" onclick="switchTab(1)">ğŸ“Š ë³€í™” ê·¸ë˜í”„</button>
    <button class="tab" onclick="switchTab(2)">ğŸ“ ì¸¡ì • ê¸°ë¡</button>
  </div>

  <!-- TAB 0: ì¸¡ì •í•˜ê¸° -->
  <div class="page active" id="page0">
    <div class="card">
      <div class="card-title"><span class="icon">ğŸ‘¤</span> íšŒì› ì„ íƒ</div>
      <div class="member-search-wrap">
        <input class="member-search" id="ms" placeholder="íšŒì› ì´ë¦„ ê²€ìƒ‰..." oninput="filterM()" onfocus="filterM()" autocomplete="off"/>
        <div class="member-dd" id="mdd"></div>
      </div>
      <input type="hidden" id="selMember" value=""/>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="btn btn-primary" style="flex:1;padding:8px;" onclick="showAddModal()">ï¼‹ ìƒˆ íšŒì›</button>
        <button class="btn" style="flex:1;padding:8px;background:#f0f0f0;color:#555;" onclick="refreshAll()">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">ğŸ©º</span> ACSM ì‚¬ì „ ìŠ¤í¬ë¦¬ë‹</div>
      <label class="acsm-check"><input type="checkbox" id="ckActive"><span>ìµœê·¼ 3ê°œì›”ê°„ ê·œì¹™ì ìœ¼ë¡œ ìš´ë™í–ˆìŠµë‹ˆê¹Œ? (ì£¼3íšŒ, 30ë¶„ ì´ìƒ)</span></label>
      <label class="acsm-check"><input type="checkbox" id="ckDisease"><span>ì‹¬ì¥, ëŒ€ì‚¬, í˜¹ì€ ì‹ ì¥ ì§ˆí™˜ ì§„ë‹¨ì„ ë°›ì•˜ìŠµë‹ˆê¹Œ?</span></label>
      <label class="acsm-check"><input type="checkbox" id="ckSymptom"><span>ìš´ë™ ì¤‘ ê°€ìŠ´ í†µì¦, í˜„ê¸°ì¦, ìˆ¨ê°€ì¨ ë“±ì˜ ì¦ìƒì´ ìˆìŠµë‹ˆê¹Œ?</span></label>
      <div id="acsmResult"></div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">ğŸ“</span> ì‹ ì²´ ê³„ì¸¡</div>
      <div class="section-label">ê¸°ë³¸ ì •ë³´</div>
      <div class="form-row">
        <div class="form-group"><label>ë‚˜ì´</label><input class="form-input" id="mAge" type="number" placeholder="30"></div>
        <div class="form-group"><label>ì„±ë³„</label><select class="form-input" id="mGender"><option value="ë‚¨">ë‚¨</option><option value="ì—¬">ì—¬</option></select></div>
      </div>
      <div class="section-label">ì²´ì„±ë¶„</div>
      <div class="measure-grid">
        <div class="measure-item"><label>ì‹ ì¥</label><input id="mHeight" type="number" step="0.1" placeholder="175"><div class="unit">cm</div></div>
        <div class="measure-item"><label>ì²´ì¤‘</label><input id="mWeight" type="number" step="0.1" placeholder="70"><div class="unit">kg</div></div>
        <div class="measure-item"><label>ì²´ì§€ë°©ë¥ </label><input id="mBF" type="number" step="0.1" placeholder="18"><div class="unit">%</div></div>
        <div class="measure-item"><label>ê³¨ê²©ê·¼ëŸ‰</label><input id="mSMM" type="number" step="0.1" placeholder="32"><div class="unit">kg</div></div>
        <div class="measure-item"><label>BMI</label><input id="mBMI" readonly style="background:#f0f0f0;color:#00d4aa;"><div class="unit">ìë™ê³„ì‚°</div></div>
        <div class="measure-item"><label>í—ˆë¦¬ë‘˜ë ˆ</label><input id="mWaist" type="number" step="0.1" placeholder="80"><div class="unit">cm</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">ğŸ’ª</span> ì²´ë ¥ ì¸¡ì •</div>
      <div class="section-label">ê·¼ë ¥ / ê·¼ì§€êµ¬ë ¥</div>
      <div class="measure-grid">
        <div class="measure-item"><label>ì•…ë ¥ (ì¢Œ)</label><input id="mGripL" type="number" step="0.1"><div class="unit">kg</div></div>
        <div class="measure-item"><label>ì•…ë ¥ (ìš°)</label><input id="mGripR" type="number" step="0.1"><div class="unit">kg</div></div>
        <div class="measure-item"><label>í‘¸ì‹œì—…</label><input id="mPushup" type="number"><div class="unit">íšŒ</div></div>
        <div class="measure-item"><label>ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°</label><input id="mSitup" type="number"><div class="unit">íšŒ/1ë¶„</div></div>
        <div class="measure-item"><label>ìŠ¤ì¿¼íŠ¸</label><input id="mSquat" type="number"><div class="unit">íšŒ/1ë¶„</div></div>
        <div class="measure-item"><label>í”Œë­í¬</label><input id="mPlank" type="number"><div class="unit">ì´ˆ</div></div>
      </div>
      <div class="section-label">ìœ ì—°ì„±</div>
      <div class="measure-grid">
        <div class="measure-item"><label>ì•‰ì•„ìœ—ëª¸ì•ìœ¼ë¡œêµ½íˆê¸°</label><input id="mFlex" type="number" step="0.1"><div class="unit">cm</div></div>
        <div class="measure-item"><label>ì–´ê¹¨ìœ ì—°ì„± (ì¢Œ)</label><input id="mShoulderL" type="text" placeholder="ì–‘í˜¸"><div class="unit">ì–‘í˜¸/ë³´í†µ/ë¶ˆëŸ‰</div></div>
        <div class="measure-item"><label>ì–´ê¹¨ìœ ì—°ì„± (ìš°)</label><input id="mShoulderR" type="text" placeholder="ì–‘í˜¸"><div class="unit">ì–‘í˜¸/ë³´í†µ/ë¶ˆëŸ‰</div></div>
      </div>
      <div class="section-label">ì‹¬íì§€êµ¬ë ¥ / ê· í˜•</div>
      <div class="measure-grid">
        <div class="measure-item"><label>ì•ˆì • ì‹œ ì‹¬ë°•ìˆ˜</label><input id="mHR" type="number"><div class="unit">bpm</div></div>
        <div class="measure-item"><label>í˜ˆì•• (ìˆ˜ì¶•ê¸°)</label><input id="mBPs" type="number"><div class="unit">mmHg</div></div>
        <div class="measure-item"><label>í˜ˆì•• (ì´ì™„ê¸°)</label><input id="mBPd" type="number"><div class="unit">mmHg</div></div>
        <div class="measure-item"><label>3ë¶„ ìŠ¤í…í…ŒìŠ¤íŠ¸</label><input id="mStep" type="number"><div class="unit">íšŒë³µì‹¬ë°•</div></div>
        <div class="measure-item"><label>í•œë°œì„œê¸° (ì¢Œ)</label><input id="mBalL" type="number"><div class="unit">ì´ˆ</div></div>
        <div class="measure-item"><label>í•œë°œì„œê¸° (ìš°)</label><input id="mBalR" type="number"><div class="unit">ì´ˆ</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">ğŸ“</span> íŠ¹ì´ì‚¬í•­ ë©”ëª¨</div>
      <textarea class="form-input" id="mMemo" rows="3" placeholder="ë¶€ìƒì´ë ¥, í†µì¦ë¶€ìœ„, ìš´ë™ëª©í‘œ ë“±..." style="width:100%;resize:vertical;"></textarea>
    </div>

    <button class="btn btn-save" onclick="saveEval()" style="margin-top:4px;">ğŸ’¾ ì¸¡ì • ê²°ê³¼ ì €ì¥</button>
  </div>

  <!-- TAB 1: ë³€í™” ê·¸ë˜í”„ -->
  <div class="page" id="page1">
    <div class="card">
      <div class="card-title"><span class="icon">ğŸ‘¤</span> íšŒì› ì„ íƒ</div>
      <div class="member-search-wrap">
        <input class="member-search" id="ms2" placeholder="íšŒì› ì´ë¦„ ê²€ìƒ‰..." oninput="filterM2()" onfocus="filterM2()" autocomplete="off"/>
        <div class="member-dd" id="mdd2"></div>
      </div>
    </div>
    <div class="card" id="graphCard" style="display:none;">
      <div class="card-title"><span class="icon">ğŸ“Š</span> <span id="graphName"></span> ë³€í™” ì¶”ì´</div>
      <div class="chart-select" id="chartChips"></div>
      <div class="chart-wrap"><canvas id="chart"></canvas></div>
    </div>
    <div class="empty-msg" id="graphEmpty">íšŒì›ì„ ì„ íƒí•˜ë©´ ë³€í™” ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
  </div>

  <!-- TAB 2: ì¸¡ì • ê¸°ë¡ -->
  <div class="page" id="page2">
    <div class="card">
      <div class="card-title"><span class="icon">ğŸ‘¤</span> íšŒì› ì„ íƒ</div>
      <div class="member-search-wrap">
        <input class="member-search" id="ms3" placeholder="íšŒì› ì´ë¦„ ê²€ìƒ‰..." oninput="filterM3()" onfocus="filterM3()" autocomplete="off"/>
        <div class="member-dd" id="mdd3"></div>
      </div>
    </div>
    <div id="historyList"></div>
    <div class="empty-msg" id="histEmpty">íšŒì›ì„ ì„ íƒí•˜ë©´ ì¸¡ì • ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
  </div>
</div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbywmcwTjvNN3BdUGQOeLLJO8jY42TLDR98clGABUHq4h9QBf2OKMQfJhI2OGboR1UDl/exec';

function toast(m){const t=document.getElementById('toast');t.textContent=m;t.className='toast show';setTimeout(()=>t.className='toast',2500);}
async function apiCall(d){try{const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(d)});return await r.json();}catch(e){return{success:false,error:e.message};}}

// â•â•â• TABS â•â•â•
function switchTab(n){
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===n));
  document.querySelectorAll('.page').forEach((p,i)=>p.classList.toggle('active',i===n));
}

// â•â•â• MEMBERS â•â•â•
let allMembers=[];
async function loadMembers(){
  try{const r=await fetch(API_URL+'?action=get_members');const d=await r.json();
  if(d.success)allMembers=d.members;}catch(e){}
}
function buildDD(q,dd,cb){
  dd.innerHTML='';
  const f=q?allMembers.filter(m=>m.name.toLowerCase().includes(q.toLowerCase())):allMembers;
  if(!f.length){dd.innerHTML='<div class="member-dd-item" style="color:#ccc;">ê²°ê³¼ ì—†ìŒ</div>';dd.classList.add('show');return;}
  f.forEach(m=>{const d=document.createElement('div');d.className='member-dd-item';d.textContent=m.name;
  d.addEventListener('mousedown',e=>{e.preventDefault();cb(m.name);});
  d.addEventListener('touchend',e=>{e.preventDefault();cb(m.name);});
  dd.appendChild(d);});dd.classList.add('show');
}
// Tab 0
function filterM(){buildDD(document.getElementById('ms').value,document.getElementById('mdd'),n=>{
  document.getElementById('ms').value=n;document.getElementById('selMember').value=n;document.getElementById('mdd').classList.remove('show');
});}
// Tab 1
function filterM2(){buildDD(document.getElementById('ms2').value,document.getElementById('mdd2'),n=>{
  document.getElementById('ms2').value=n;document.getElementById('mdd2').classList.remove('show');loadGraph(n);
});}
// Tab 2
function filterM3(){buildDD(document.getElementById('ms3').value,document.getElementById('mdd3'),n=>{
  document.getElementById('ms3').value=n;document.getElementById('mdd3').classList.remove('show');loadHistory(n);
});}
document.addEventListener('click',e=>{document.querySelectorAll('.member-dd').forEach(d=>{if(!e.target.closest('.member-search-wrap'))d.classList.remove('show');});});

function showAddModal(){document.getElementById('newMemberName').value='';document.getElementById('addModal').classList.add('show');setTimeout(()=>document.getElementById('newMemberName').focus(),100);}
async function addMemberConfirm(){
  const n=document.getElementById('newMemberName').value.trim();if(!n)return;
  document.getElementById('addModal').classList.remove('show');toast('â³ ë“±ë¡ì¤‘...');
  const r=await apiCall({action:'add_member',member:n});
  if(r.success){toast('âœ… '+n+' ë“±ë¡!');loadMembers();document.getElementById('ms').value=n;document.getElementById('selMember').value=n;}
  else toast('âŒ '+(r.error||'ì‹¤íŒ¨'));
}
async function refreshAll(){toast('ğŸ“¥ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');await loadMembers();toast('âœ… ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');}

// â•â•â• BMI AUTO CALC â•â•â•
document.getElementById('mHeight').addEventListener('input',calcBMI);
document.getElementById('mWeight').addEventListener('input',calcBMI);
function calcBMI(){
  const h=parseFloat(document.getElementById('mHeight').value);
  const w=parseFloat(document.getElementById('mWeight').value);
  if(h>0&&w>0)document.getElementById('mBMI').value=(w/((h/100)**2)).toFixed(1);
  else document.getElementById('mBMI').value='';
}

// â•â•â• ACSM â•â•â•
['ckActive','ckDisease','ckSymptom'].forEach(id=>document.getElementById(id).addEventListener('change',updateACSM));
function updateACSM(){
  const active=document.getElementById('ckActive').checked;
  const disease=document.getElementById('ckDisease').checked;
  const symptom=document.getElementById('ckSymptom').checked;
  let msg='',cls='';
  if(!active){
    if(!disease&&!symptom){msg='âœ… ì¦‰ì‹œ ê°€ë²¼ìš´/ì¤‘ê°•ë„ ìš´ë™ ì‹œì‘ ê°€ëŠ¥ (ì ì§„ì  ì¦ê°•)';cls='safe';}
    else{msg='âš ï¸ ìš´ë™ ì „ ì˜ë£Œì§„ì˜ ìŠ¹ì¸(Medical Clearance)ì´ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.';cls='warn';}
  }else{
    if(symptom){msg='ğŸš¨ ì¦‰ì‹œ ìš´ë™ ì¤‘ë‹¨ í›„ ì˜ë£Œì§„ì˜ ê²€ì‚¬ë¥¼ ë°›ìœ¼ì„¸ìš”.';cls='danger';}
    else if(disease){msg='âœ… ì¤‘ê°•ë„ ìš´ë™ ìœ ì§€ ê°€ëŠ¥ (ê³ ê°•ë„ëŠ” ì˜ë£Œì§„ ìƒë‹´ ê¶Œì¥)';cls='warn';}
    else{msg='âœ… ì¤‘ê°•ë„ ë° ê³ ê°•ë„ ìš´ë™ ì§€ì† ê°€ëŠ¥';cls='safe';}
  }
  const el=document.getElementById('acsmResult');
  el.className='acsm-result '+cls;el.textContent=msg;
}

// â•â•â• SAVE â•â•â•
async function saveEval(){
  const member=document.getElementById('selMember').value;
  if(!member){toast('âš ï¸ íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”!');return;}
  const data={
    action:'save_eval',member:member,
    date:new Date().toLocaleDateString('ko-KR'),
    age:document.getElementById('mAge').value,
    gender:document.getElementById('mGender').value,
    height:document.getElementById('mHeight').value,
    weight:document.getElementById('mWeight').value,
    bf:document.getElementById('mBF').value,
    smm:document.getElementById('mSMM').value,
    bmi:document.getElementById('mBMI').value,
    waist:document.getElementById('mWaist').value,
    gripL:document.getElementById('mGripL').value,
    gripR:document.getElementById('mGripR').value,
    pushup:document.getElementById('mPushup').value,
    situp:document.getElementById('mSitup').value,
    squat:document.getElementById('mSquat').value,
    plank:document.getElementById('mPlank').value,
    flex:document.getElementById('mFlex').value,
    shoulderL:document.getElementById('mShoulderL').value,
    shoulderR:document.getElementById('mShoulderR').value,
    hr:document.getElementById('mHR').value,
    bps:document.getElementById('mBPs').value,
    bpd:document.getElementById('mBPd').value,
    step:document.getElementById('mStep').value,
    balL:document.getElementById('mBalL').value,
    balR:document.getElementById('mBalR').value,
    acsm:document.getElementById('acsmResult').textContent,
    memo:document.getElementById('mMemo').value
  };
  toast('â³ ì €ì¥ì¤‘...');
  const r=await apiCall(data);
  if(r.success)toast('âœ… ì¸¡ì • ê²°ê³¼ ì €ì¥ ì™„ë£Œ!');
  else toast('âŒ '+(r.error||'ì €ì¥ ì‹¤íŒ¨'));
}

// â•â•â• GRAPH â•â•â•
const METRICS=[
  {key:'weight',label:'ì²´ì¤‘',unit:'kg',color:'#e53935'},
  {key:'bf',label:'ì²´ì§€ë°©ë¥ ',unit:'%',color:'#FF9800'},
  {key:'smm',label:'ê³¨ê²©ê·¼ëŸ‰',unit:'kg',color:'#2196F3'},
  {key:'bmi',label:'BMI',unit:'',color:'#9C27B0'},
  {key:'gripL',label:'ì•…ë ¥(ì¢Œ)',unit:'kg',color:'#00BCD4'},
  {key:'gripR',label:'ì•…ë ¥(ìš°)',unit:'kg',color:'#009688'},
  {key:'pushup',label:'í‘¸ì‹œì—…',unit:'íšŒ',color:'#4CAF50'},
  {key:'situp',label:'ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°',unit:'íšŒ',color:'#8BC34A'},
  {key:'plank',label:'í”Œë­í¬',unit:'ì´ˆ',color:'#FF5722'},
  {key:'flex',label:'ìœ ì—°ì„±',unit:'cm',color:'#795548'},
  {key:'hr',label:'ì•ˆì •ì‹œì‹¬ë°•',unit:'bpm',color:'#607D8B'},
  {key:'waist',label:'í—ˆë¦¬ë‘˜ë ˆ',unit:'cm',color:'#F44336'}
];
let chartInstance=null,graphData=[],activeMetrics=['weight','bf','smm'];
function renderChips(){
  const c=document.getElementById('chartChips');c.innerHTML='';
  METRICS.forEach(m=>{
    const ch=document.createElement('button');ch.className='chip'+(activeMetrics.includes(m.key)?' active':'');
    ch.style.borderColor=activeMetrics.includes(m.key)?m.color:'#e0e0e0';
    if(activeMetrics.includes(m.key)){ch.style.background=m.color;ch.style.color='white';}
    ch.textContent=m.label;
    ch.onclick=()=>{
      if(activeMetrics.includes(m.key))activeMetrics=activeMetrics.filter(k=>k!==m.key);
      else activeMetrics.push(m.key);
      renderChips();renderChart();
    };c.appendChild(ch);
  });
}
function renderChart(){
  const ctx=document.getElementById('chart');
  if(chartInstance)chartInstance.destroy();
  const labels=graphData.map(d=>d.date);
  const datasets=activeMetrics.map(key=>{
    const m=METRICS.find(x=>x.key===key);
    return{label:m.label+(m.unit?' ('+m.unit+')':''),data:graphData.map(d=>parseFloat(d[key])||0),
    borderColor:m.color,backgroundColor:m.color+'33',tension:0.3,pointRadius:5,pointHoverRadius:7,borderWidth:2.5,fill:false};
  });
  chartInstance=new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:'bottom',labels:{font:{family:'Noto Sans KR',weight:'bold',size:11},usePointStyle:true}}},
    scales:{y:{beginAtZero:false,grid:{color:'#f0f0f0'}},x:{grid:{display:false}}}}});
}
async function loadGraph(name){
  document.getElementById('graphEmpty').style.display='none';
  document.getElementById('graphCard').style.display='block';
  document.getElementById('graphName').textContent=name+'ë‹˜';
  try{
    const r=await fetch(API_URL+'?action=get_evals&member='+encodeURIComponent(name));
    const d=await r.json();
    if(d.success){graphData=d.evals||[];renderChips();renderChart();}
  }catch(e){toast('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');}
}

// â•â•â• HISTORY â•â•â•
let histData=[];
async function loadHistory(name){
  document.getElementById('histEmpty').style.display='none';
  const list=document.getElementById('historyList');list.innerHTML='';
  try{
    const r=await fetch(API_URL+'?action=get_evals&member='+encodeURIComponent(name));
    const d=await r.json();
    if(d.success){
      histData=d.evals||[];
      if(!histData.length){list.innerHTML='<div class="empty-msg">ì¸¡ì • ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}
      histData.forEach((ev,i)=>{
        const item=document.createElement('div');item.className='hist-item';
        item.innerHTML='<div><div class="hist-date">'+(i+1)+'íšŒì°¨ â€” '+ev.date+'</div><div class="hist-bmi">ì²´ì¤‘: '+(ev.weight||'-')+'kg | BMI: '+(ev.bmi||'-')+' | ì²´ì§€ë°©: '+(ev.bf||'-')+'%</div></div>';
        item.onclick=()=>showHistDetail(ev,i);
        list.appendChild(item);
      });
    }
  }catch(e){toast('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');}
}
function showHistDetail(ev,idx){
  let msg=(idx+1)+'íšŒì°¨ ('+ev.date+')\n\n';
  msg+='ì²´ì¤‘: '+(ev.weight||'-')+'kg\n';
  msg+='ì²´ì§€ë°©ë¥ : '+(ev.bf||'-')+'%\n';
  msg+='ê³¨ê²©ê·¼ëŸ‰: '+(ev.smm||'-')+'kg\n';
  msg+='BMI: '+(ev.bmi||'-')+'\n';
  msg+='í—ˆë¦¬ë‘˜ë ˆ: '+(ev.waist||'-')+'cm\n\n';
  msg+='ì•…ë ¥: ì¢Œ '+(ev.gripL||'-')+' / ìš° '+(ev.gripR||'-')+'kg\n';
  msg+='í‘¸ì‹œì—…: '+(ev.pushup||'-')+'íšŒ\n';
  msg+='ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°: '+(ev.situp||'-')+'íšŒ\n';
  msg+='í”Œë­í¬: '+(ev.plank||'-')+'ì´ˆ\n';
  msg+='ìœ ì—°ì„±: '+(ev.flex||'-')+'cm\n\n';
  msg+='ì•ˆì •ì‹œì‹¬ë°•: '+(ev.hr||'-')+'bpm\n';
  msg+='í˜ˆì••: '+(ev.bps||'-')+'/'+(ev.bpd||'-')+'\n';
  msg+='ACSM: '+(ev.acsm||'-')+'\n';
  msg+='ë©”ëª¨: '+(ev.memo||'-');
  alert(msg);
}

// â•â•â• INIT â•â•â•
loadMembers();
</script>
</body>
</html>
